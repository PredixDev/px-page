<link rel="import" href="../px-mobile/px-mobile.html"/>
<script type="text/javascript">
  px.pages = {
    // add properties and methods on the element's prototype
    properties : {

      // declare properties for the element's public API
      title : {
        type : String,
        value : 'Predix Mobile Page'
      },

      //The default selected Page
      selected: {
        type: Number,
        reflectToAttribute: true,
        notify: true,
        observer: '_selectedChanged',
        value: 0
      },

      //The current context of the Page.
      context : {
        type : Object,
        value : {}
      },

      //The list of pages
      pages : {
        type : Object,
        value : {}
      },

      PageList : {
        type : Array
      },

      //The pages routes
      routes : {
        type : Object,
        value : {}
      }
    },

    created : function() {
      var logger = new px.mobile.Logger(this.tagName, {colors: {debug: 'color:blue'}});
      px.mobile.utils.addMixin(logger, this);

      this.logApi(this.id, 'created');

      this.PageMap = {};
      this.PageList = [];
    },
    ready : function() {
      this.logApi(this.id, 'ready');
    },

    attached : function() {
      this.logApi('attached', this.id + ' - ' + this.selected);
      if (!this.id) {
        throw 'pages' + this.tagName + ' cannot be created without an id!';
      }
      this._initpages();

    },
    _initpages: function(){
      var self = this;
      this.logApi('_initpages', this);
      Polymer.dom(this).querySelectorAll('px-page').forEach(function(Page){
        self._addPage(Page);
      });
      this.changePage(this.selected);
      this.fire('px-pages-ready');
    },

    //show Page
    showPage: function(index){
      console.warn('INFO', 'show Page', this.id);

      this.PageList[this.selected].toggleClass('current');
      this.PageList[this.selected].child()[0].toggleClass('current');
      this.PageList[this.selected].child()[0].toggleClass('et-page-current');
      this.PageList[this.selected].toggleClass('previous');
      this.PageList[this.selected].child()[0].toggleClass('previous');
      this.PageList[this.selected].addClass('hidden');
      this.PageList[this.selected].child()[0].addClass('hidden');

      this.selected = index;
      this.PageList[this.selected].removeClass('hidden');
      this.PageList[this.selected].child()[0].removeClass('hidden');
      this.PageList[this.selected].toggleClass('current');
      this.PageList[this.selected].child()[0].toggleClass('current');
      this.PageList[this.selected].child()[0].toggleClass('et-page-current');

    },

    //hide Page
    hidePage: function(index){
      console.warn('INFO', 'hide Page', this.id);
      this.toggleClass('hidden', true, this);
    },

    //update Page
    updatePage: function(){
      console.warn('INFO', 'update Page', this.id);
    },

    getCurrentPage: function(){
      console.warn('INFO', 'current Page', this.id);
      return px.mobile.dom(this.id).find('.current');
    },

    _selectedChanged: function(newVal, oldVal){
      this.logApi('_selectedChanged', oldVal + ' => ' + newVal);

      //newVal++;
      if(oldVal && this.PageList[oldVal]){
        //the previous Page
        this.PageList[oldVal].toggleClass('previous');
      }

      //set the selected Page
      if(newVal && this.PageList[newVal]){
        //set current Page
        this._setCurrent(newVal, oldVal);
      }
    },

    //Handle adding a Page to the map
    _addPage: function(Page){
      var index = this.PageList.length;

      //add the index to the el
      Page.attr('index', index.toString());

      //add next class to element
      Page.addClass('next');

      //push to Page list
      this.PageList.push(Page);

      //add to Page map
      this.PageMap[Page.id] = Page;

      //log
      this.logApi('_addPage', {id: Page.id, index: index});
    },

    //Handle clearing all the 'current' classes.
    _clearCurrent: function(){
      this.logApi('_clearCurrent');
      var _pages = Polymer.dom(this).querySelectorAll('px-page');
      if(_pages){
        _pages.forEach(function(Page){
          Page.removeClass('current');
        });
      }
    }
  };

  px.pages._setCurrent = function(index, oldIndex){
    this.logApi('_setCurrent', index);
    if(this.PageList[oldIndex]){
      console.log('removing Current from', this.PageList[oldIndex]);
      this.PageList[oldIndex].removeClass('current');
      this.PageList[oldIndex].removeClass('et-page-current');
      this.PageList[oldIndex].addClass('previous');
    }

    if(this.PageList[index]){
      this.PageList[index].removeClass('next');
      this.PageList[index].removeClass('previous');
      this.PageList[index].removeClass('hidden');
      this.PageList[index].addClass('current');
      this.PageList[index].addClass('et-page-current');
    }
  };

  px.pages.changePage = function(indexOrId){
    this.logApi('changePage', indexOrId);
    this._clearCurrent();
    if(this.PageList[indexOrId]){
      this._setCurrent(indexOrId);
    } else if(this.PageMap[indexOrId]){
      this._setCurrent(this.PageList.indexOf(this.PageMap[indexOrId]) + 1);
    }
  };

  px.pages.nextPage = function(){
      var items = this.PageList;
    this.selected++;
  	if(this.selected >= items.length){
  		this.selected = this.selected - items.length;
  	}
    console.log('next-' + this.selected);
  };

  px.pages.prevPage = function(){
    var items = this.PageList;
    var index = this.selected;
    this.selected--;
    if(this.selected >= items.length){
      this.selected = items.length;
    }

    if(this.selected >= items.length){
      this.selected = this.selected - items.length - 1;
    }
    console.log('prev-' + this.selected);
  };

</script>
